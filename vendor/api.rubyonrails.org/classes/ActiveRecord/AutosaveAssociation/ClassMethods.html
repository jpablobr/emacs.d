<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <title>Module: ActiveRecord::AutosaveAssociation::ClassMethods</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="../../../rdoc-style.css" type="text/css" media="screen" />

    <script language="JavaScript" type="text/javascript">
    // <![CDATA[

        function toggleSource( id )
        {
          var elem
          var link

          if( document.getElementById )
          {
            elem = document.getElementById( id )
            link = document.getElementById( "l_" + id )
          }
          else if ( document.all )
          {
            elem = eval( "document.all." + id )
            link = eval( "document.all.l_" + id )
          }
          else
            return false;

          if( elem.style.display == "block" )
          {
            elem.style.display = "none"
            link.innerHTML = "show source"
          }
          else
          {
            elem.style.display = "block"
            link.innerHTML = "hide source"
          }
        }

        function openCode( url )
        {
          window.open( url, "SOURCE_CODE", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=480,width=750" ).focus();
        }
      // ]]>
    </script>
  </head>

  <body>
    <table width="100%" border='0' cellpadding='0' cellspacing='0' class='banner'>
    <tr><td>Ruby on Rails v3.0.3</td></tr>
    <tr>
  <td class="file-title"><span class="file-title-prefix">Module</span><br />ActiveRecord::AutosaveAssociation::ClassMethods</td>
  <td align="right">
    <table cellspacing="0" cellpadding="2">
      <tr valign="top">
        <td>In:</td>
        <td>
<a href="../../../files/activerecord/lib/active_record/autosave_association_rb.html">activerecord/lib/active_record/autosave_association.rb</a>:
        </td>
      </tr>
         </table>
        </td>
        </tr>
      </table>
  <div id="bodyContent">
  <div id="content">

  <div class="description"></div>


  <div class="sectiontitle">Methods</div>
  <ul>
                <li><a href="#method-i-add_autosave_association_callbacks">add_autosave_association_callbacks</a></li>
      </ul>




                                
    <div class="sectiontitle">
      Private      Instance      methods
    </div>

          
      <div class="method">
        <div class="title">
                      <a name="method-i-add_autosave_association_callbacks"></a>
            <b>add_autosave_association_callbacks</b>(reflection)          
        </div>

                  <div class="description">
            <p>
Adds validation and save callbacks for the association as specified by the
<tt>reflection</tt>.
</p>
<p>
For performance reasons, we don&#8217;t check whether to validate at
runtime. However the validation and callback methods are lazy and those
methods get created when they are invoked for the very first time. 
However, this can change, for instance, when using nested attributes, which
is called <em>after</em> the association has been defined. Since we
don&#8217;t want the callbacks to get defined multiple times, there are
guards that check if the save or validation methods have already been
defined before actually defining them.
</p>          </div>
        
        
                  <div class="sourcecode">
            <p class="source-link">[
            <a href="javascript:toggleSource('add-autosave-association-callbacks_source')"
                 id="l_method-i-add_autosave_association_callbacks_source">
              show source
            </a> ]</p>
            <div class="dyn-source"
                    id="add-autosave-association-callbacks_source">
<pre>
       <span class="ruby-comment cmt"># File activerecord/lib/active_record/autosave_association.rb, line 154</span>
154:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add_autosave_association_callbacks</span>(<span class="ruby-identifier">reflection</span>)
155:         <span class="ruby-identifier">save_method</span> = <span class="ruby-value">:&quot;autosave_associated_records_for_#{reflection.name}&quot;</span>
156:         <span class="ruby-identifier">validation_method</span> = <span class="ruby-value">:&quot;validate_associated_records_for_#{reflection.name}&quot;</span>
157:         <span class="ruby-identifier">collection</span> = <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">collection?</span>
158: 
159:         <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">method_defined?</span>(<span class="ruby-identifier">save_method</span>)
160:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">collection</span>
161:             <span class="ruby-identifier">before_save</span> <span class="ruby-value">:before_save_collection_association</span>
162: 
163:             <span class="ruby-identifier">define_method</span>(<span class="ruby-identifier">save_method</span>) { <span class="ruby-identifier">save_collection_association</span>(<span class="ruby-identifier">reflection</span>) }
164:             <span class="ruby-comment cmt"># Doesn't use after_save as that would save associations added in after_create/after_update twice</span>
165:             <span class="ruby-identifier">after_create</span> <span class="ruby-identifier">save_method</span>
166:             <span class="ruby-identifier">after_update</span> <span class="ruby-identifier">save_method</span>
167:           <span class="ruby-keyword kw">else</span>
168:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">macro</span> <span class="ruby-operator">==</span> <span class="ruby-value">:has_one</span>
169:               <span class="ruby-identifier">define_method</span>(<span class="ruby-identifier">save_method</span>) { <span class="ruby-identifier">save_has_one_association</span>(<span class="ruby-identifier">reflection</span>) }
170:               <span class="ruby-identifier">after_save</span> <span class="ruby-identifier">save_method</span>
171:             <span class="ruby-keyword kw">else</span>
172:               <span class="ruby-identifier">define_method</span>(<span class="ruby-identifier">save_method</span>) { <span class="ruby-identifier">save_belongs_to_association</span>(<span class="ruby-identifier">reflection</span>) }
173:               <span class="ruby-identifier">before_save</span> <span class="ruby-identifier">save_method</span>
174:             <span class="ruby-keyword kw">end</span>
175:           <span class="ruby-keyword kw">end</span>
176:         <span class="ruby-keyword kw">end</span>
177: 
178:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">validate?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">method_defined?</span>(<span class="ruby-identifier">validation_method</span>)
179:           <span class="ruby-identifier">method</span> = (<span class="ruby-identifier">collection</span> <span class="ruby-operator">?</span> <span class="ruby-value">:validate_collection_association</span> <span class="ruby-operator">:</span> <span class="ruby-value">:validate_single_association</span>)
180:           <span class="ruby-identifier">define_method</span>(<span class="ruby-identifier">validation_method</span>) { <span class="ruby-identifier">send</span>(<span class="ruby-identifier">method</span>, <span class="ruby-identifier">reflection</span>) }
181:           <span class="ruby-identifier">validate</span> <span class="ruby-identifier">validation_method</span>
182:         <span class="ruby-keyword kw">end</span>
183:       <span class="ruby-keyword kw">end</span></pre>
            </div>
          </div>
        
      </div>

      </div>
  </div>
  </body>
</html>
