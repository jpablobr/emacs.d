<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <title>Module: ActiveRecord::AssociationPreload::ClassMethods</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="../../../rdoc-style.css" type="text/css" media="screen" />

    <script language="JavaScript" type="text/javascript">
    // <![CDATA[

        function toggleSource( id )
        {
          var elem
          var link

          if( document.getElementById )
          {
            elem = document.getElementById( id )
            link = document.getElementById( "l_" + id )
          }
          else if ( document.all )
          {
            elem = eval( "document.all." + id )
            link = eval( "document.all.l_" + id )
          }
          else
            return false;

          if( elem.style.display == "block" )
          {
            elem.style.display = "none"
            link.innerHTML = "show source"
          }
          else
          {
            elem.style.display = "block"
            link.innerHTML = "hide source"
          }
        }

        function openCode( url )
        {
          window.open( url, "SOURCE_CODE", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=480,width=750" ).focus();
        }
      // ]]>
    </script>
  </head>

  <body>
    <table width="100%" border='0' cellpadding='0' cellspacing='0' class='banner'>
    <tr><td>Ruby on Rails v3.0.3</td></tr>
    <tr>
  <td class="file-title"><span class="file-title-prefix">Module</span><br />ActiveRecord::AssociationPreload::ClassMethods</td>
  <td align="right">
    <table cellspacing="0" cellpadding="2">
      <tr valign="top">
        <td>In:</td>
        <td>
<a href="../../../files/activerecord/lib/active_record/association_preload_rb.html">activerecord/lib/active_record/association_preload.rb</a>:
        </td>
      </tr>
         </table>
        </td>
        </tr>
      </table>
  <div id="bodyContent">
  <div id="content">

  <div class="description"><p>
Implements the details of eager loading of Active Record associations.
Application developers should not use this module directly.
</p>
<p>
<tt>ActiveRecord::Base</tt> is extended with this module. The source code
in <tt>ActiveRecord::Base</tt> references methods defined in this module.
</p>
<p>
Note that &#8216;eager loading&#8217; and &#8216;preloading&#8217; are
actually the same thing. However, there are two different eager loading
strategies.
</p>
<p>
The first one is by using table joins. This was only strategy available
prior to <a href="../../Rails.html">Rails</a> 2.1. Suppose that you have an
Author model with columns &#8216;name&#8217; and &#8216;age&#8217;, and a
Book model with columns &#8216;name&#8217; and &#8216;sales&#8217;. Using
this strategy, Active Record would try to retrieve all data for an author
and all of its books via a single query:
</p>
<pre>
  SELECT * FROM authors
  LEFT OUTER JOIN books ON authors.id = books.id
  WHERE authors.name = 'Ken Akamatsu'
</pre>
<p>
However, this could result in many rows that contain redundant data. After
having received the first row, we already have enough data to instantiate
the Author object. In all subsequent rows, only the data for the joined
&#8216;books&#8217; table is useful; the joined &#8216;authors&#8217; data
is just redundant, and processing this redundant data takes memory and CPU
time. The problem quickly becomes worse and worse as the level of eager
loading increases (i.e. if Active Record is to eager load the
associations&#8217; associations as well).
</p>
<p>
The second strategy is to use multiple database queries, one for each level
of association. Since <a href="../../Rails.html">Rails</a> 2.1, this is the
default strategy. In situations where a table join is necessary (e.g. when
the <tt>:conditions</tt> option references an association&#8217;s column),
it will fallback to the table join strategy.
</p>
<p>
See also <a
href="../Associations/ClassMethods.html">ActiveRecord::Associations::ClassMethods</a>,
which explains eager loading in a more high-level (application
developer-friendly) manner.
</p>
</div>


  <div class="sectiontitle">Methods</div>
  <ul>
                <li><a href="#method-i-add_preloaded_record_to_collection">add_preloaded_record_to_collection</a></li>
                <li><a href="#method-i-add_preloaded_records_to_collection">add_preloaded_records_to_collection</a></li>
                <li><a href="#method-i-append_conditions">append_conditions</a></li>
                <li><a href="#method-i-construct_id_map">construct_id_map</a></li>
                <li><a href="#method-i-find_associated_records">find_associated_records</a></li>
                <li><a href="#method-i-in_or_equals_for_ids">in_or_equals_for_ids</a></li>
                <li><a href="#method-i-interpolate_sql_for_preload">interpolate_sql_for_preload</a></li>
                <li><a href="#method-i-preload_associations">preload_associations</a></li>
                <li><a href="#method-i-preload_belongs_to_association">preload_belongs_to_association</a></li>
                <li><a href="#method-i-preload_has_and_belongs_to_many_association">preload_has_and_belongs_to_many_association</a></li>
                <li><a href="#method-i-preload_has_many_association">preload_has_many_association</a></li>
                <li><a href="#method-i-preload_has_one_association">preload_has_one_association</a></li>
                <li><a href="#method-i-preload_one_association">preload_one_association</a></li>
                <li><a href="#method-i-preload_through_records">preload_through_records</a></li>
                <li><a href="#method-i-set_association_collection_records">set_association_collection_records</a></li>
                <li><a href="#method-i-set_association_single_records">set_association_single_records</a></li>
      </ul>




                            
    <div class="sectiontitle">
      Protected      Instance      methods
    </div>

          
      <div class="method">
        <div class="title">
                      <a name="method-i-preload_associations"></a>
            <b>preload_associations</b>(records, associations, preload_options={})          
        </div>

                  <div class="description">
            <p>
Eager loads the named associations for the given Active Record record(s).
</p>
<p>
In this description, &#8216;association name&#8217; shall refer to the name
passed to an association creation method. For example, a model that
specifies <tt>belongs_to :author</tt>, <tt>has_many :buyers</tt> has
association names <tt>:author</tt> and <tt>:buyers</tt>.
</p>
<h2>Parameters</h2>
<p>
<tt>records</tt> is an array of <a
href="../Base.html">ActiveRecord::Base</a>. This array needs not be flat,
i.e. <tt>records</tt> itself may also contain arrays of records. In any
case, <tt><a
href="ClassMethods.html#method-i-preload_associations">preload_associations</a></tt>
will preload the all associations records by flattening <tt>records</tt>.
</p>
<p>
<tt>associations</tt> specifies one or more associations that you want to
preload. It may be:
</p>
<ul>
<li><p>
a Symbol or a String which specifies a single association name. For
example, specifying <tt>:books</tt> allows this method to preload all books
for an Author.
</p>
</li>
<li><p>
an Array which specifies multiple association names. This array is
processed recursively. For example, specifying <tt>[:avatar, :books]</tt>
allows this method to preload an author&#8217;s avatar as well as all of
his books.
</p>
</li>
<li><p>
a Hash which specifies multiple association names, as well as association
names for the to-be-preloaded association objects. For example, specifying
<tt>{ :author =&gt; :avatar }</tt> will preload a book&#8217;s author, as
well as that author&#8217;s avatar.
</p>
</li>
</ul>
<p>
<tt>:associations</tt> has the same format as the <tt>:include</tt> option
for <tt>ActiveRecord::Base.find</tt>. So <tt>associations</tt> could look
like this:
</p>
<pre>
  :books
  [ :books, :author ]
  { :author =&gt; :avatar }
  [ :books, { :author =&gt; :avatar } ]
</pre>
<p>
<tt>preload_options</tt> contains options that will be passed to
ActiveRecord::Base#find (which is called under the hood for preloading
records). But it is passed only one level deep in the <tt>associations</tt>
argument, i.e. it&#8217;s not passed to the child associations when
<tt>associations</tt> is a Hash.
</p>          </div>
        
        
                  <div class="sourcecode">
            <p class="source-link">[
            <a href="javascript:toggleSource('preload-associations_source')"
                 id="l_method-i-preload_associations_source">
              show source
            </a> ]</p>
            <div class="dyn-source"
                    id="preload-associations_source">
<pre>
       <span class="ruby-comment cmt"># File activerecord/lib/active_record/association_preload.rb, line 87</span>
 87:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">preload_associations</span>(<span class="ruby-identifier">records</span>, <span class="ruby-identifier">associations</span>, <span class="ruby-identifier">preload_options</span>={})
 88:         <span class="ruby-identifier">records</span> = <span class="ruby-constant">Array</span>.<span class="ruby-identifier">wrap</span>(<span class="ruby-identifier">records</span>).<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">uniq</span>
 89:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">records</span>.<span class="ruby-identifier">empty?</span>
 90:         <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">associations</span>
 91:         <span class="ruby-keyword kw">when</span> <span class="ruby-constant">Array</span> <span class="ruby-keyword kw">then</span> <span class="ruby-identifier">associations</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">association</span><span class="ruby-operator">|</span> <span class="ruby-identifier">preload_associations</span>(<span class="ruby-identifier">records</span>, <span class="ruby-identifier">association</span>, <span class="ruby-identifier">preload_options</span>)}
 92:         <span class="ruby-keyword kw">when</span> <span class="ruby-constant">Symbol</span>, <span class="ruby-constant">String</span> <span class="ruby-keyword kw">then</span> <span class="ruby-identifier">preload_one_association</span>(<span class="ruby-identifier">records</span>, <span class="ruby-identifier">associations</span>.<span class="ruby-identifier">to_sym</span>, <span class="ruby-identifier">preload_options</span>)
 93:         <span class="ruby-keyword kw">when</span> <span class="ruby-constant">Hash</span> <span class="ruby-keyword kw">then</span>
 94:           <span class="ruby-identifier">associations</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">parent</span>, <span class="ruby-identifier">child</span><span class="ruby-operator">|</span>
 95:             <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;parent must be an association name&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">parent</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">String</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">parent</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Symbol</span>)
 96:             <span class="ruby-identifier">preload_associations</span>(<span class="ruby-identifier">records</span>, <span class="ruby-identifier">parent</span>, <span class="ruby-identifier">preload_options</span>)
 97:             <span class="ruby-identifier">reflection</span> = <span class="ruby-identifier">reflections</span>[<span class="ruby-identifier">parent</span>]
 98:             <span class="ruby-identifier">parents</span> = <span class="ruby-identifier">records</span>.<span class="ruby-identifier">sum</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">record</span><span class="ruby-operator">|</span> <span class="ruby-constant">Array</span>.<span class="ruby-identifier">wrap</span>(<span class="ruby-identifier">record</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">name</span>)) }
 99:             <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">parents</span>.<span class="ruby-identifier">empty?</span>
100:               <span class="ruby-identifier">parents</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">preload_associations</span>(<span class="ruby-identifier">parents</span>, <span class="ruby-identifier">child</span>)
101:             <span class="ruby-keyword kw">end</span>
102:           <span class="ruby-keyword kw">end</span>
103:         <span class="ruby-keyword kw">end</span>
104:       <span class="ruby-keyword kw">end</span></pre>
            </div>
          </div>
        
      </div>

          
    <div class="sectiontitle">
      Private      Instance      methods
    </div>

          
      <div class="method">
        <div class="title">
                      <a name="method-i-add_preloaded_record_to_collection"></a>
            <b>add_preloaded_record_to_collection</b>(parent_records, reflection_name, associated_record)          
        </div>

                  <div class="description">
                      </div>
        
        
                  <div class="sourcecode">
            <p class="source-link">[
            <a href="javascript:toggleSource('add-preloaded-record-to-collection_source')"
                 id="l_method-i-add_preloaded_record_to_collection_source">
              show source
            </a> ]</p>
            <div class="dyn-source"
                    id="add-preloaded-record-to-collection_source">
<pre>
       <span class="ruby-comment cmt"># File activerecord/lib/active_record/association_preload.rb, line 135</span>
135:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add_preloaded_record_to_collection</span>(<span class="ruby-identifier">parent_records</span>, <span class="ruby-identifier">reflection_name</span>, <span class="ruby-identifier">associated_record</span>)
136:         <span class="ruby-identifier">parent_records</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">parent_record</span><span class="ruby-operator">|</span>
137:           <span class="ruby-identifier">parent_record</span>.<span class="ruby-identifier">send</span>(<span class="ruby-node">&quot;set_#{reflection_name}_target&quot;</span>, <span class="ruby-identifier">associated_record</span>)
138:         <span class="ruby-keyword kw">end</span>
139:       <span class="ruby-keyword kw">end</span></pre>
            </div>
          </div>
        
      </div>

          
      <div class="method">
        <div class="title">
                      <a name="method-i-add_preloaded_records_to_collection"></a>
            <b>add_preloaded_records_to_collection</b>(parent_records, reflection_name, associated_record)          
        </div>

                  <div class="description">
                      </div>
        
        
                  <div class="sourcecode">
            <p class="source-link">[
            <a href="javascript:toggleSource('add-preloaded-records-to-collection_source')"
                 id="l_method-i-add_preloaded_records_to_collection_source">
              show source
            </a> ]</p>
            <div class="dyn-source"
                    id="add-preloaded-records-to-collection_source">
<pre>
       <span class="ruby-comment cmt"># File activerecord/lib/active_record/association_preload.rb, line 125</span>
125:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add_preloaded_records_to_collection</span>(<span class="ruby-identifier">parent_records</span>, <span class="ruby-identifier">reflection_name</span>, <span class="ruby-identifier">associated_record</span>)
126:         <span class="ruby-identifier">parent_records</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">parent_record</span><span class="ruby-operator">|</span>
127:           <span class="ruby-identifier">association_proxy</span> = <span class="ruby-identifier">parent_record</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">reflection_name</span>)
128:           <span class="ruby-identifier">association_proxy</span>.<span class="ruby-identifier">loaded</span>
129:           <span class="ruby-identifier">association_proxy</span>.<span class="ruby-identifier">target</span>.<span class="ruby-identifier">push</span>(*<span class="ruby-constant">Array</span>.<span class="ruby-identifier">wrap</span>(<span class="ruby-identifier">associated_record</span>))
130: 
131:           <span class="ruby-identifier">association_proxy</span>.<span class="ruby-identifier">__send__</span>(<span class="ruby-value">:set_inverse_instance</span>, <span class="ruby-identifier">associated_record</span>, <span class="ruby-identifier">parent_record</span>)
132:         <span class="ruby-keyword kw">end</span>
133:       <span class="ruby-keyword kw">end</span></pre>
            </div>
          </div>
        
      </div>

          
      <div class="method">
        <div class="title">
                      <a name="method-i-append_conditions"></a>
            <b>append_conditions</b>(reflection, preload_options)          
        </div>

                  <div class="description">
                      </div>
        
        
                  <div class="sourcecode">
            <p class="source-link">[
            <a href="javascript:toggleSource('append-conditions_source')"
                 id="l_method-i-append_conditions_source">
              show source
            </a> ]</p>
            <div class="dyn-source"
                    id="append-conditions_source">
<pre>
       <span class="ruby-comment cmt"># File activerecord/lib/active_record/association_preload.rb, line 391</span>
391:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">append_conditions</span>(<span class="ruby-identifier">reflection</span>, <span class="ruby-identifier">preload_options</span>)
392:         <span class="ruby-identifier">sql</span> = <span class="ruby-value str">&quot;&quot;</span>
393:         <span class="ruby-identifier">sql</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot; AND (#{interpolate_sql_for_preload(reflection.sanitized_conditions)})&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">sanitized_conditions</span>
394:         <span class="ruby-identifier">sql</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot; AND (#{sanitize_sql preload_options[:conditions]})&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">preload_options</span>[<span class="ruby-value">:conditions</span>]
395:         <span class="ruby-identifier">sql</span>
396:       <span class="ruby-keyword kw">end</span></pre>
            </div>
          </div>
        
      </div>

          
      <div class="method">
        <div class="title">
                      <a name="method-i-construct_id_map"></a>
            <b>construct_id_map</b>(records, primary_key=nil)          
        </div>

                  <div class="description">
            <p>
Given a collection of Active Record objects, constructs a Hash which maps
the objects&#8217; IDs to the relevant objects. Returns a 2-tuple
<tt>(id_to_record_map, ids)</tt> where <tt>id_to_record_map</tt> is the
Hash, and <tt>ids</tt> is an Array of record IDs.
</p>          </div>
        
        
                  <div class="sourcecode">
            <p class="source-link">[
            <a href="javascript:toggleSource('construct-id-map_source')"
                 id="l_method-i-construct_id_map_source">
              show source
            </a> ]</p>
            <div class="dyn-source"
                    id="construct-id-map_source">
<pre>
       <span class="ruby-comment cmt"># File activerecord/lib/active_record/association_preload.rb, line 174</span>
174:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">construct_id_map</span>(<span class="ruby-identifier">records</span>, <span class="ruby-identifier">primary_key</span>=<span class="ruby-keyword kw">nil</span>)
175:         <span class="ruby-identifier">id_to_record_map</span> = {}
176:         <span class="ruby-identifier">ids</span> = []
177:         <span class="ruby-identifier">records</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">record</span><span class="ruby-operator">|</span>
178:           <span class="ruby-identifier">primary_key</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">record</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">primary_key</span>
179:           <span class="ruby-identifier">ids</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">record</span>[<span class="ruby-identifier">primary_key</span>]
180:           <span class="ruby-identifier">mapped_records</span> = (<span class="ruby-identifier">id_to_record_map</span>[<span class="ruby-identifier">ids</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">to_s</span>] <span class="ruby-operator">||=</span> [])
181:           <span class="ruby-identifier">mapped_records</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">record</span>
182:         <span class="ruby-keyword kw">end</span>
183:         <span class="ruby-identifier">ids</span>.<span class="ruby-identifier">uniq!</span>
184:         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">id_to_record_map</span>, <span class="ruby-identifier">ids</span>
185:       <span class="ruby-keyword kw">end</span></pre>
            </div>
          </div>
        
      </div>

          
      <div class="method">
        <div class="title">
                      <a name="method-i-find_associated_records"></a>
            <b>find_associated_records</b>(ids, reflection, preload_options)          
        </div>

                  <div class="description">
                      </div>
        
        
                  <div class="sourcecode">
            <p class="source-link">[
            <a href="javascript:toggleSource('find-associated-records_source')"
                 id="l_method-i-find_associated_records_source">
              show source
            </a> ]</p>
            <div class="dyn-source"
                    id="find-associated-records_source">
<pre>
       <span class="ruby-comment cmt"># File activerecord/lib/active_record/association_preload.rb, line 361</span>
361:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">find_associated_records</span>(<span class="ruby-identifier">ids</span>, <span class="ruby-identifier">reflection</span>, <span class="ruby-identifier">preload_options</span>)
362:         <span class="ruby-identifier">options</span> = <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">options</span>
363:         <span class="ruby-identifier">table_name</span> = <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">klass</span>.<span class="ruby-identifier">quoted_table_name</span>
364: 
365:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">interface</span> = <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">options</span>[<span class="ruby-value">:as</span>]
366:           <span class="ruby-identifier">conditions</span> = <span class="ruby-node">&quot;#{reflection.klass.quoted_table_name}.#{connection.quote_column_name &quot;#{interface}_id&quot;} #{in_or_equals_for_ids(ids)} and #{reflection.klass.quoted_table_name}.#{connection.quote_column_name &quot;#{interface}_type&quot;} = '#{self.base_class.sti_name}'&quot;</span>
367:         <span class="ruby-keyword kw">else</span>
368:           <span class="ruby-identifier">foreign_key</span> = <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">primary_key_name</span>
369:           <span class="ruby-identifier">conditions</span> = <span class="ruby-node">&quot;#{reflection.klass.quoted_table_name}.#{foreign_key} #{in_or_equals_for_ids(ids)}&quot;</span>
370:         <span class="ruby-keyword kw">end</span>
371: 
372:         <span class="ruby-identifier">conditions</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">append_conditions</span>(<span class="ruby-identifier">reflection</span>, <span class="ruby-identifier">preload_options</span>)
373: 
374:         <span class="ruby-identifier">find_options</span> = {
375:           <span class="ruby-value">:select</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">preload_options</span>[<span class="ruby-value">:select</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:select</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">Arel</span><span class="ruby-operator">::</span><span class="ruby-constant">SqlLiteral</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;#{table_name}.*&quot;</span>),
376:           <span class="ruby-value">:include</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">preload_options</span>[<span class="ruby-value">:include</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:include</span>],
377:           <span class="ruby-value">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">conditions</span>, <span class="ruby-identifier">ids</span>],
378:           <span class="ruby-value">:joins</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:joins</span>],
379:           <span class="ruby-value">:group</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">preload_options</span>[<span class="ruby-value">:group</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:group</span>],
380:           <span class="ruby-value">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">preload_options</span>[<span class="ruby-value">:order</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:order</span>]
381:         }
382: 
383:         <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">klass</span>.<span class="ruby-identifier">scoped</span>.<span class="ruby-identifier">apply_finder_options</span>(<span class="ruby-identifier">find_options</span>).<span class="ruby-identifier">to_a</span>
384:       <span class="ruby-keyword kw">end</span></pre>
            </div>
          </div>
        
      </div>

          
      <div class="method">
        <div class="title">
                      <a name="method-i-in_or_equals_for_ids"></a>
            <b>in_or_equals_for_ids</b>(ids)          
        </div>

                  <div class="description">
                      </div>
        
        
                  <div class="sourcecode">
            <p class="source-link">[
            <a href="javascript:toggleSource('in-or-equals-for-ids_source')"
                 id="l_method-i-in_or_equals_for_ids_source">
              show source
            </a> ]</p>
            <div class="dyn-source"
                    id="in-or-equals-for-ids_source">
<pre>
       <span class="ruby-comment cmt"># File activerecord/lib/active_record/association_preload.rb, line 398</span>
398:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">in_or_equals_for_ids</span>(<span class="ruby-identifier">ids</span>)
399:         <span class="ruby-identifier">ids</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span> <span class="ruby-operator">?</span> <span class="ruby-value str">&quot;IN (?)&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-value str">&quot;= ?&quot;</span>
400:       <span class="ruby-keyword kw">end</span></pre>
            </div>
          </div>
        
      </div>

          
      <div class="method">
        <div class="title">
                      <a name="method-i-interpolate_sql_for_preload"></a>
            <b>interpolate_sql_for_preload</b>(sql)          
        </div>

                  <div class="description">
                      </div>
        
        
                  <div class="sourcecode">
            <p class="source-link">[
            <a href="javascript:toggleSource('interpolate-sql-for-preload_source')"
                 id="l_method-i-interpolate_sql_for_preload_source">
              show source
            </a> ]</p>
            <div class="dyn-source"
                    id="interpolate-sql-for-preload_source">
<pre>
       <span class="ruby-comment cmt"># File activerecord/lib/active_record/association_preload.rb, line 387</span>
387:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">interpolate_sql_for_preload</span>(<span class="ruby-identifier">sql</span>)
388:         <span class="ruby-identifier">instance_eval</span>(<span class="ruby-node">&quot;%@#{sql.gsub('@', '\@')}@&quot;</span>, <span class="ruby-keyword kw">__FILE__</span>, <span class="ruby-keyword kw">__LINE__</span>)
389:       <span class="ruby-keyword kw">end</span></pre>
            </div>
          </div>
        
      </div>

          
      <div class="method">
        <div class="title">
                      <a name="method-i-preload_belongs_to_association"></a>
            <b>preload_belongs_to_association</b>(records, reflection, preload_options={})          
        </div>

                  <div class="description">
                      </div>
        
        
                  <div class="sourcecode">
            <p class="source-link">[
            <a href="javascript:toggleSource('preload-belongs-to-association_source')"
                 id="l_method-i-preload_belongs_to_association_source">
              show source
            </a> ]</p>
            <div class="dyn-source"
                    id="preload-belongs-to-association_source">
<pre>
       <span class="ruby-comment cmt"># File activerecord/lib/active_record/association_preload.rb, line 299</span>
299:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">preload_belongs_to_association</span>(<span class="ruby-identifier">records</span>, <span class="ruby-identifier">reflection</span>, <span class="ruby-identifier">preload_options</span>={})
300:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">records</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">send</span>(<span class="ruby-node">&quot;loaded_#{reflection.name}?&quot;</span>)
301:         <span class="ruby-identifier">options</span> = <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">options</span>
302:         <span class="ruby-identifier">primary_key_name</span> = <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">primary_key_name</span>
303: 
304:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:polymorphic</span>]
305:           <span class="ruby-identifier">polymorph_type</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:foreign_type</span>]
306:           <span class="ruby-identifier">klasses_and_ids</span> = {}
307: 
308:           <span class="ruby-comment cmt"># Construct a mapping from klass to a list of ids to load and a mapping of those ids back</span>
309:           <span class="ruby-comment cmt"># to their parent_records</span>
310:           <span class="ruby-identifier">records</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">record</span><span class="ruby-operator">|</span>
311:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">klass</span> = <span class="ruby-identifier">record</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">polymorph_type</span>)
312:               <span class="ruby-identifier">klass_id</span> = <span class="ruby-identifier">record</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">primary_key_name</span>)
313:               <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">klass_id</span>
314:                 <span class="ruby-identifier">id_map</span> = <span class="ruby-identifier">klasses_and_ids</span>[<span class="ruby-identifier">klass</span>] <span class="ruby-operator">||=</span> {}
315:                 <span class="ruby-identifier">id_list_for_klass_id</span> = (<span class="ruby-identifier">id_map</span>[<span class="ruby-identifier">klass_id</span>.<span class="ruby-identifier">to_s</span>] <span class="ruby-operator">||=</span> [])
316:                 <span class="ruby-identifier">id_list_for_klass_id</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">record</span>
317:               <span class="ruby-keyword kw">end</span>
318:             <span class="ruby-keyword kw">end</span>
319:           <span class="ruby-keyword kw">end</span>
320:           <span class="ruby-identifier">klasses_and_ids</span> = <span class="ruby-identifier">klasses_and_ids</span>.<span class="ruby-identifier">to_a</span>
321:         <span class="ruby-keyword kw">else</span>
322:           <span class="ruby-identifier">id_map</span> = {}
323:           <span class="ruby-identifier">records</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">record</span><span class="ruby-operator">|</span>
324:             <span class="ruby-identifier">key</span> = <span class="ruby-identifier">record</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">primary_key_name</span>)
325:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">key</span>
326:               <span class="ruby-identifier">mapped_records</span> = (<span class="ruby-identifier">id_map</span>[<span class="ruby-identifier">key</span>.<span class="ruby-identifier">to_s</span>] <span class="ruby-operator">||=</span> [])
327:               <span class="ruby-identifier">mapped_records</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">record</span>
328:             <span class="ruby-keyword kw">end</span>
329:           <span class="ruby-keyword kw">end</span>
330:           <span class="ruby-identifier">klasses_and_ids</span> = [[<span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">klass</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">id_map</span>]]
331:         <span class="ruby-keyword kw">end</span>
332: 
333:         <span class="ruby-identifier">klasses_and_ids</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">klass_and_id</span><span class="ruby-operator">|</span>
334:           <span class="ruby-identifier">klass_name</span>, <span class="ruby-identifier">id_map</span> = *<span class="ruby-identifier">klass_and_id</span>
335:           <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">id_map</span>.<span class="ruby-identifier">empty?</span>
336:           <span class="ruby-identifier">klass</span> = <span class="ruby-identifier">klass_name</span>.<span class="ruby-identifier">constantize</span>
337: 
338:           <span class="ruby-identifier">table_name</span> = <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">quoted_table_name</span>
339:           <span class="ruby-identifier">primary_key</span> = <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">options</span>[<span class="ruby-value">:primary_key</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">primary_key</span>
340:           <span class="ruby-identifier">column_type</span> = <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">columns</span>.<span class="ruby-identifier">detect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">c</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">primary_key</span>}.<span class="ruby-identifier">type</span>
341: 
342:           <span class="ruby-identifier">ids</span> = <span class="ruby-identifier">id_map</span>.<span class="ruby-identifier">keys</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">id</span><span class="ruby-operator">|</span>
343:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">column_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:integer</span>
344:               <span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_i</span>
345:             <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">column_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:float</span>
346:               <span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_f</span>
347:             <span class="ruby-keyword kw">else</span>
348:               <span class="ruby-identifier">id</span>
349:             <span class="ruby-keyword kw">end</span>
350:           <span class="ruby-keyword kw">end</span>
351: 
352:           <span class="ruby-identifier">conditions</span> = <span class="ruby-node">&quot;#{table_name}.#{connection.quote_column_name(primary_key)} #{in_or_equals_for_ids(ids)}&quot;</span>
353:           <span class="ruby-identifier">conditions</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">append_conditions</span>(<span class="ruby-identifier">reflection</span>, <span class="ruby-identifier">preload_options</span>)
354: 
355:           <span class="ruby-identifier">associated_records</span> = <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">unscoped</span>.<span class="ruby-identifier">where</span>([<span class="ruby-identifier">conditions</span>, <span class="ruby-identifier">ids</span>]).<span class="ruby-identifier">apply_finder_options</span>(<span class="ruby-identifier">options</span>.<span class="ruby-identifier">slice</span>(<span class="ruby-value">:include</span>, <span class="ruby-value">:select</span>, <span class="ruby-value">:joins</span>, <span class="ruby-value">:order</span>)).<span class="ruby-identifier">to_a</span>
356: 
357:           <span class="ruby-identifier">set_association_single_records</span>(<span class="ruby-identifier">id_map</span>, <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">associated_records</span>, <span class="ruby-identifier">primary_key</span>)
358:         <span class="ruby-keyword kw">end</span>
359:       <span class="ruby-keyword kw">end</span></pre>
            </div>
          </div>
        
      </div>

          
      <div class="method">
        <div class="title">
                      <a name="method-i-preload_has_and_belongs_to_many_association"></a>
            <b>preload_has_and_belongs_to_many_association</b>(records, reflection, preload_options={})          
        </div>

                  <div class="description">
                      </div>
        
        
                  <div class="sourcecode">
            <p class="source-link">[
            <a href="javascript:toggleSource('preload-has-and-belongs-to-many-association_source')"
                 id="l_method-i-preload_has_and_belongs_to_many_association_source">
              show source
            </a> ]</p>
            <div class="dyn-source"
                    id="preload-has-and-belongs-to-many-association_source">
<pre>
       <span class="ruby-comment cmt"># File activerecord/lib/active_record/association_preload.rb, line 187</span>
187:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">preload_has_and_belongs_to_many_association</span>(<span class="ruby-identifier">records</span>, <span class="ruby-identifier">reflection</span>, <span class="ruby-identifier">preload_options</span>={})
188:         <span class="ruby-identifier">table_name</span> = <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">klass</span>.<span class="ruby-identifier">quoted_table_name</span>
189:         <span class="ruby-identifier">id_to_record_map</span>, <span class="ruby-identifier">ids</span> = <span class="ruby-identifier">construct_id_map</span>(<span class="ruby-identifier">records</span>)
190:         <span class="ruby-identifier">records</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">record</span><span class="ruby-operator">|</span> <span class="ruby-identifier">record</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">name</span>).<span class="ruby-identifier">loaded</span>}
191:         <span class="ruby-identifier">options</span> = <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">options</span>
192: 
193:         <span class="ruby-identifier">conditions</span> = <span class="ruby-node">&quot;t0.#{reflection.primary_key_name} #{in_or_equals_for_ids(ids)}&quot;</span>
194:         <span class="ruby-identifier">conditions</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">append_conditions</span>(<span class="ruby-identifier">reflection</span>, <span class="ruby-identifier">preload_options</span>)
195: 
196:         <span class="ruby-identifier">associated_records</span> = <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">klass</span>.<span class="ruby-identifier">unscoped</span>.<span class="ruby-identifier">where</span>([<span class="ruby-identifier">conditions</span>, <span class="ruby-identifier">ids</span>]).
197:             <span class="ruby-identifier">includes</span>(<span class="ruby-identifier">options</span>[<span class="ruby-value">:include</span>]).
198:             <span class="ruby-identifier">joins</span>(<span class="ruby-node">&quot;INNER JOIN #{connection.quote_table_name options[:join_table]} t0 ON #{reflection.klass.quoted_table_name}.#{reflection.klass.primary_key} = t0.#{reflection.association_foreign_key}&quot;</span>).
199:             <span class="ruby-identifier">select</span>(<span class="ruby-node">&quot;#{options[:select] || table_name+'.*'}, t0.#{reflection.primary_key_name} as the_parent_record_id&quot;</span>).
200:             <span class="ruby-identifier">order</span>(<span class="ruby-identifier">options</span>[<span class="ruby-value">:order</span>]).<span class="ruby-identifier">to_a</span>
201: 
202:         <span class="ruby-identifier">set_association_collection_records</span>(<span class="ruby-identifier">id_to_record_map</span>, <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">associated_records</span>, <span class="ruby-value str">'the_parent_record_id'</span>)
203:       <span class="ruby-keyword kw">end</span></pre>
            </div>
          </div>
        
      </div>

          
      <div class="method">
        <div class="title">
                      <a name="method-i-preload_has_many_association"></a>
            <b>preload_has_many_association</b>(records, reflection, preload_options={})          
        </div>

                  <div class="description">
                      </div>
        
        
                  <div class="sourcecode">
            <p class="source-link">[
            <a href="javascript:toggleSource('preload-has-many-association_source')"
                 id="l_method-i-preload_has_many_association_source">
              show source
            </a> ]</p>
            <div class="dyn-source"
                    id="preload-has-many-association_source">
<pre>
       <span class="ruby-comment cmt"># File activerecord/lib/active_record/association_preload.rb, line 236</span>
236:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">preload_has_many_association</span>(<span class="ruby-identifier">records</span>, <span class="ruby-identifier">reflection</span>, <span class="ruby-identifier">preload_options</span>={})
237:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">records</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">name</span>).<span class="ruby-identifier">loaded?</span>
238:         <span class="ruby-identifier">options</span> = <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">options</span>
239: 
240:         <span class="ruby-identifier">primary_key_name</span> = <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">through_reflection_primary_key_name</span>
241:         <span class="ruby-identifier">id_to_record_map</span>, <span class="ruby-identifier">ids</span> = <span class="ruby-identifier">construct_id_map</span>(<span class="ruby-identifier">records</span>, <span class="ruby-identifier">primary_key_name</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">options</span>[<span class="ruby-value">:primary_key</span>])
242:         <span class="ruby-identifier">records</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">record</span><span class="ruby-operator">|</span> <span class="ruby-identifier">record</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">name</span>).<span class="ruby-identifier">loaded</span>}
243: 
244:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:through</span>]
245:           <span class="ruby-identifier">through_records</span> = <span class="ruby-identifier">preload_through_records</span>(<span class="ruby-identifier">records</span>, <span class="ruby-identifier">reflection</span>, <span class="ruby-identifier">options</span>[<span class="ruby-value">:through</span>])
246:           <span class="ruby-identifier">through_reflection</span> = <span class="ruby-identifier">reflections</span>[<span class="ruby-identifier">options</span>[<span class="ruby-value">:through</span>]]
247:           <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">through_records</span>.<span class="ruby-identifier">empty?</span>
248:             <span class="ruby-identifier">source</span> = <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">source_reflection</span>.<span class="ruby-identifier">name</span>
249:             <span class="ruby-identifier">through_records</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">preload_associations</span>(<span class="ruby-identifier">through_records</span>, <span class="ruby-identifier">source</span>, <span class="ruby-identifier">options</span>)
250:             <span class="ruby-identifier">through_records</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">through_record</span><span class="ruby-operator">|</span>
251:               <span class="ruby-identifier">through_record_id</span> = <span class="ruby-identifier">through_record</span>[<span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">through_reflection_primary_key</span>].<span class="ruby-identifier">to_s</span>
252:               <span class="ruby-identifier">add_preloaded_records_to_collection</span>(<span class="ruby-identifier">id_to_record_map</span>[<span class="ruby-identifier">through_record_id</span>], <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">through_record</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">source</span>))
253:             <span class="ruby-keyword kw">end</span>
254:           <span class="ruby-keyword kw">end</span>
255: 
256:         <span class="ruby-keyword kw">else</span>
257:           <span class="ruby-identifier">set_association_collection_records</span>(<span class="ruby-identifier">id_to_record_map</span>, <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">find_associated_records</span>(<span class="ruby-identifier">ids</span>, <span class="ruby-identifier">reflection</span>, <span class="ruby-identifier">preload_options</span>),
258:                                              <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">primary_key_name</span>)
259:         <span class="ruby-keyword kw">end</span>
260:       <span class="ruby-keyword kw">end</span></pre>
            </div>
          </div>
        
      </div>

          
      <div class="method">
        <div class="title">
                      <a name="method-i-preload_has_one_association"></a>
            <b>preload_has_one_association</b>(records, reflection, preload_options={})          
        </div>

                  <div class="description">
                      </div>
        
        
                  <div class="sourcecode">
            <p class="source-link">[
            <a href="javascript:toggleSource('preload-has-one-association_source')"
                 id="l_method-i-preload_has_one_association_source">
              show source
            </a> ]</p>
            <div class="dyn-source"
                    id="preload-has-one-association_source">
<pre>
       <span class="ruby-comment cmt"># File activerecord/lib/active_record/association_preload.rb, line 205</span>
205:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">preload_has_one_association</span>(<span class="ruby-identifier">records</span>, <span class="ruby-identifier">reflection</span>, <span class="ruby-identifier">preload_options</span>={})
206:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">records</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">send</span>(<span class="ruby-node">&quot;loaded_#{reflection.name}?&quot;</span>)
207:         <span class="ruby-identifier">id_to_record_map</span>, <span class="ruby-identifier">ids</span> = <span class="ruby-identifier">construct_id_map</span>(<span class="ruby-identifier">records</span>, <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">options</span>[<span class="ruby-value">:primary_key</span>])
208:         <span class="ruby-identifier">options</span> = <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">options</span>
209:         <span class="ruby-identifier">records</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">record</span><span class="ruby-operator">|</span> <span class="ruby-identifier">record</span>.<span class="ruby-identifier">send</span>(<span class="ruby-node">&quot;set_#{reflection.name}_target&quot;</span>, <span class="ruby-keyword kw">nil</span>)}
210:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:through</span>]
211:           <span class="ruby-identifier">through_records</span> = <span class="ruby-identifier">preload_through_records</span>(<span class="ruby-identifier">records</span>, <span class="ruby-identifier">reflection</span>, <span class="ruby-identifier">options</span>[<span class="ruby-value">:through</span>])
212:           <span class="ruby-identifier">through_reflection</span> = <span class="ruby-identifier">reflections</span>[<span class="ruby-identifier">options</span>[<span class="ruby-value">:through</span>]]
213:           <span class="ruby-identifier">through_primary_key</span> = <span class="ruby-identifier">through_reflection</span>.<span class="ruby-identifier">primary_key_name</span>
214:           <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">through_records</span>.<span class="ruby-identifier">empty?</span>
215:             <span class="ruby-identifier">source</span> = <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">source_reflection</span>.<span class="ruby-identifier">name</span>
216:             <span class="ruby-identifier">through_records</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">preload_associations</span>(<span class="ruby-identifier">through_records</span>, <span class="ruby-identifier">source</span>)
217:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">through_reflection</span>.<span class="ruby-identifier">macro</span> <span class="ruby-operator">==</span> <span class="ruby-value">:belongs_to</span>
218:               <span class="ruby-identifier">rev_id_to_record_map</span>, <span class="ruby-identifier">rev_ids</span> = <span class="ruby-identifier">construct_id_map</span>(<span class="ruby-identifier">records</span>, <span class="ruby-identifier">through_primary_key</span>)
219:               <span class="ruby-identifier">rev_primary_key</span> = <span class="ruby-identifier">through_reflection</span>.<span class="ruby-identifier">klass</span>.<span class="ruby-identifier">primary_key</span>
220:               <span class="ruby-identifier">through_records</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">through_record</span><span class="ruby-operator">|</span>
221:                 <span class="ruby-identifier">add_preloaded_record_to_collection</span>(<span class="ruby-identifier">rev_id_to_record_map</span>[<span class="ruby-identifier">through_record</span>[<span class="ruby-identifier">rev_primary_key</span>].<span class="ruby-identifier">to_s</span>],
222:                                                    <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">through_record</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">source</span>))
223:               <span class="ruby-keyword kw">end</span>
224:             <span class="ruby-keyword kw">else</span>
225:               <span class="ruby-identifier">through_records</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">through_record</span><span class="ruby-operator">|</span>
226:                 <span class="ruby-identifier">add_preloaded_record_to_collection</span>(<span class="ruby-identifier">id_to_record_map</span>[<span class="ruby-identifier">through_record</span>[<span class="ruby-identifier">through_primary_key</span>].<span class="ruby-identifier">to_s</span>],
227:                                                    <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">through_record</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">source</span>))
228:               <span class="ruby-keyword kw">end</span>
229:             <span class="ruby-keyword kw">end</span>
230:           <span class="ruby-keyword kw">end</span>
231:         <span class="ruby-keyword kw">else</span>
232:           <span class="ruby-identifier">set_association_single_records</span>(<span class="ruby-identifier">id_to_record_map</span>, <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">find_associated_records</span>(<span class="ruby-identifier">ids</span>, <span class="ruby-identifier">reflection</span>, <span class="ruby-identifier">preload_options</span>), <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">primary_key_name</span>)
233:         <span class="ruby-keyword kw">end</span>
234:       <span class="ruby-keyword kw">end</span></pre>
            </div>
          </div>
        
      </div>

          
      <div class="method">
        <div class="title">
                      <a name="method-i-preload_one_association"></a>
            <b>preload_one_association</b>(records, association, preload_options={})          
        </div>

                  <div class="description">
            <p>
Preloads a specific named association for the given records. This is called
by <tt><a
href="ClassMethods.html#method-i-preload_associations">preload_associations</a></tt>
as its base case.
</p>          </div>
        
        
                  <div class="sourcecode">
            <p class="source-link">[
            <a href="javascript:toggleSource('preload-one-association_source')"
                 id="l_method-i-preload_one_association_source">
              show source
            </a> ]</p>
            <div class="dyn-source"
                    id="preload-one-association_source">
<pre>
       <span class="ruby-comment cmt"># File activerecord/lib/active_record/association_preload.rb, line 110</span>
110:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">preload_one_association</span>(<span class="ruby-identifier">records</span>, <span class="ruby-identifier">association</span>, <span class="ruby-identifier">preload_options</span>={})
111:         <span class="ruby-identifier">class_to_reflection</span> = {}
112:         <span class="ruby-comment cmt"># Not all records have the same class, so group then preload</span>
113:         <span class="ruby-comment cmt"># group on the reflection itself so that if various subclass share the same association then</span>
114:         <span class="ruby-comment cmt"># we do not split them unnecessarily</span>
115:         <span class="ruby-identifier">records</span>.<span class="ruby-identifier">group_by</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">record</span><span class="ruby-operator">|</span> <span class="ruby-identifier">class_to_reflection</span>[<span class="ruby-identifier">record</span>.<span class="ruby-identifier">class</span>] <span class="ruby-operator">||=</span> <span class="ruby-identifier">record</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">reflections</span>[<span class="ruby-identifier">association</span>]}.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">reflection</span>, <span class="ruby-identifier">_records</span><span class="ruby-operator">|</span>
116:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">ConfigurationError</span>, <span class="ruby-node">&quot;Association named '#{ association }' was not found; perhaps you misspelled it?&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">reflection</span>
117: 
118:           <span class="ruby-comment cmt"># 'reflection.macro' can return 'belongs_to', 'has_many', etc. Thus,</span>
119:           <span class="ruby-comment cmt"># the following could call 'preload_belongs_to_association',</span>
120:           <span class="ruby-comment cmt"># 'preload_has_many_association', etc.</span>
121:           <span class="ruby-identifier">send</span>(<span class="ruby-node">&quot;preload_#{reflection.macro}_association&quot;</span>, <span class="ruby-identifier">_records</span>, <span class="ruby-identifier">reflection</span>, <span class="ruby-identifier">preload_options</span>)
122:         <span class="ruby-keyword kw">end</span>
123:       <span class="ruby-keyword kw">end</span></pre>
            </div>
          </div>
        
      </div>

          
      <div class="method">
        <div class="title">
                      <a name="method-i-preload_through_records"></a>
            <b>preload_through_records</b>(records, reflection, through_association)          
        </div>

                  <div class="description">
                      </div>
        
        
                  <div class="sourcecode">
            <p class="source-link">[
            <a href="javascript:toggleSource('preload-through-records_source')"
                 id="l_method-i-preload_through_records_source">
              show source
            </a> ]</p>
            <div class="dyn-source"
                    id="preload-through-records_source">
<pre>
       <span class="ruby-comment cmt"># File activerecord/lib/active_record/association_preload.rb, line 262</span>
262:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">preload_through_records</span>(<span class="ruby-identifier">records</span>, <span class="ruby-identifier">reflection</span>, <span class="ruby-identifier">through_association</span>)
263:         <span class="ruby-identifier">through_reflection</span> = <span class="ruby-identifier">reflections</span>[<span class="ruby-identifier">through_association</span>]
264:         <span class="ruby-identifier">through_primary_key</span> = <span class="ruby-identifier">through_reflection</span>.<span class="ruby-identifier">primary_key_name</span>
265: 
266:         <span class="ruby-identifier">through_records</span> = []
267:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">options</span>[<span class="ruby-value">:source_type</span>]
268:           <span class="ruby-identifier">interface</span> = <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">source_reflection</span>.<span class="ruby-identifier">options</span>[<span class="ruby-value">:foreign_type</span>]
269:           <span class="ruby-identifier">preload_options</span> = {<span class="ruby-value">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;#{connection.quote_column_name interface} = ?&quot;</span>, <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">options</span>[<span class="ruby-value">:source_type</span>]]}
270: 
271:           <span class="ruby-identifier">records</span>.<span class="ruby-identifier">compact!</span>
272:           <span class="ruby-identifier">records</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">preload_associations</span>(<span class="ruby-identifier">records</span>, <span class="ruby-identifier">through_association</span>, <span class="ruby-identifier">preload_options</span>)
273: 
274:           <span class="ruby-comment cmt"># Dont cache the association - we would only be caching a subset</span>
275:           <span class="ruby-identifier">records</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">record</span><span class="ruby-operator">|</span>
276:             <span class="ruby-identifier">proxy</span> = <span class="ruby-identifier">record</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">through_association</span>)
277: 
278:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">proxy</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:target</span>)
279:               <span class="ruby-identifier">through_records</span>.<span class="ruby-identifier">concat</span> <span class="ruby-constant">Array</span>.<span class="ruby-identifier">wrap</span>(<span class="ruby-identifier">proxy</span>.<span class="ruby-identifier">target</span>)
280:               <span class="ruby-identifier">proxy</span>.<span class="ruby-identifier">reset</span>
281:             <span class="ruby-keyword kw">else</span> <span class="ruby-comment cmt"># this is a has_one :through reflection</span>
282:               <span class="ruby-identifier">through_records</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">proxy</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">proxy</span>
283:             <span class="ruby-keyword kw">end</span>
284:           <span class="ruby-keyword kw">end</span>
285:         <span class="ruby-keyword kw">else</span>
286:           <span class="ruby-identifier">options</span> = {}
287:           <span class="ruby-identifier">options</span>[<span class="ruby-value">:include</span>] = <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">options</span>[<span class="ruby-value">:include</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">options</span>[<span class="ruby-value">:source</span>] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">options</span>[<span class="ruby-value">:conditions</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">options</span>[<span class="ruby-value">:order</span>]
288:           <span class="ruby-identifier">options</span>[<span class="ruby-value">:order</span>] = <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">options</span>[<span class="ruby-value">:order</span>]
289:           <span class="ruby-identifier">options</span>[<span class="ruby-value">:conditions</span>] = <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">options</span>[<span class="ruby-value">:conditions</span>]
290:           <span class="ruby-identifier">records</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">preload_associations</span>(<span class="ruby-identifier">records</span>, <span class="ruby-identifier">through_association</span>, <span class="ruby-identifier">options</span>)
291: 
292:           <span class="ruby-identifier">records</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">record</span><span class="ruby-operator">|</span>
293:             <span class="ruby-identifier">through_records</span>.<span class="ruby-identifier">concat</span> <span class="ruby-constant">Array</span>.<span class="ruby-identifier">wrap</span>(<span class="ruby-identifier">record</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">through_association</span>))
294:           <span class="ruby-keyword kw">end</span>
295:         <span class="ruby-keyword kw">end</span>
296:         <span class="ruby-identifier">through_records</span>
297:       <span class="ruby-keyword kw">end</span></pre>
            </div>
          </div>
        
      </div>

          
      <div class="method">
        <div class="title">
                      <a name="method-i-set_association_collection_records"></a>
            <b>set_association_collection_records</b>(id_to_record_map, reflection_name, associated_records, key)          
        </div>

                  <div class="description">
                      </div>
        
        
                  <div class="sourcecode">
            <p class="source-link">[
            <a href="javascript:toggleSource('set-association-collection-records_source')"
                 id="l_method-i-set_association_collection_records_source">
              show source
            </a> ]</p>
            <div class="dyn-source"
                    id="set-association-collection-records_source">
<pre>
       <span class="ruby-comment cmt"># File activerecord/lib/active_record/association_preload.rb, line 141</span>
141:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">set_association_collection_records</span>(<span class="ruby-identifier">id_to_record_map</span>, <span class="ruby-identifier">reflection_name</span>, <span class="ruby-identifier">associated_records</span>, <span class="ruby-identifier">key</span>)
142:         <span class="ruby-identifier">associated_records</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">associated_record</span><span class="ruby-operator">|</span>
143:           <span class="ruby-identifier">mapped_records</span> = <span class="ruby-identifier">id_to_record_map</span>[<span class="ruby-identifier">associated_record</span>[<span class="ruby-identifier">key</span>].<span class="ruby-identifier">to_s</span>]
144:           <span class="ruby-identifier">add_preloaded_records_to_collection</span>(<span class="ruby-identifier">mapped_records</span>, <span class="ruby-identifier">reflection_name</span>, <span class="ruby-identifier">associated_record</span>)
145:         <span class="ruby-keyword kw">end</span>
146:       <span class="ruby-keyword kw">end</span></pre>
            </div>
          </div>
        
      </div>

          
      <div class="method">
        <div class="title">
                      <a name="method-i-set_association_single_records"></a>
            <b>set_association_single_records</b>(id_to_record_map, reflection_name, associated_records, key)          
        </div>

                  <div class="description">
                      </div>
        
        
                  <div class="sourcecode">
            <p class="source-link">[
            <a href="javascript:toggleSource('set-association-single-records_source')"
                 id="l_method-i-set_association_single_records_source">
              show source
            </a> ]</p>
            <div class="dyn-source"
                    id="set-association-single-records_source">
<pre>
       <span class="ruby-comment cmt"># File activerecord/lib/active_record/association_preload.rb, line 148</span>
148:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">set_association_single_records</span>(<span class="ruby-identifier">id_to_record_map</span>, <span class="ruby-identifier">reflection_name</span>, <span class="ruby-identifier">associated_records</span>, <span class="ruby-identifier">key</span>)
149:         <span class="ruby-identifier">seen_keys</span> = {}
150:         <span class="ruby-identifier">associated_records</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">associated_record</span><span class="ruby-operator">|</span>
151:           <span class="ruby-comment cmt">#this is a has_one or belongs_to: there should only be one record.</span>
152:           <span class="ruby-comment cmt">#Unfortunately we can't (in portable way) ask the database for</span>
153:           <span class="ruby-comment cmt">#'all records where foo_id in (x,y,z), but please</span>
154:           <span class="ruby-comment cmt"># only one row per distinct foo_id' so this where we enforce that</span>
155:           <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">seen_keys</span>[<span class="ruby-identifier">associated_record</span>[<span class="ruby-identifier">key</span>].<span class="ruby-identifier">to_s</span>]
156:           <span class="ruby-identifier">seen_keys</span>[<span class="ruby-identifier">associated_record</span>[<span class="ruby-identifier">key</span>].<span class="ruby-identifier">to_s</span>] = <span class="ruby-keyword kw">true</span>
157:           <span class="ruby-identifier">mapped_records</span> = <span class="ruby-identifier">id_to_record_map</span>[<span class="ruby-identifier">associated_record</span>[<span class="ruby-identifier">key</span>].<span class="ruby-identifier">to_s</span>]
158:           <span class="ruby-identifier">mapped_records</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">mapped_record</span><span class="ruby-operator">|</span>
159:             <span class="ruby-identifier">association_proxy</span> = <span class="ruby-identifier">mapped_record</span>.<span class="ruby-identifier">send</span>(<span class="ruby-node">&quot;set_#{reflection_name}_target&quot;</span>, <span class="ruby-identifier">associated_record</span>)
160:             <span class="ruby-identifier">association_proxy</span>.<span class="ruby-identifier">__send__</span>(<span class="ruby-value">:set_inverse_instance</span>, <span class="ruby-identifier">associated_record</span>, <span class="ruby-identifier">mapped_record</span>)
161:           <span class="ruby-keyword kw">end</span>
162:         <span class="ruby-keyword kw">end</span>
163: 
164:         <span class="ruby-identifier">id_to_record_map</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">id</span>, <span class="ruby-identifier">records</span><span class="ruby-operator">|</span>
165:           <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">seen_keys</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>)
166:           <span class="ruby-identifier">records</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">record</span><span class="ruby-operator">|</span> <span class="ruby-identifier">record</span>.<span class="ruby-identifier">send</span>(<span class="ruby-node">&quot;set_#{reflection_name}_target&quot;</span>, <span class="ruby-keyword kw">nil</span>) }
167:         <span class="ruby-keyword kw">end</span>
168:       <span class="ruby-keyword kw">end</span></pre>
            </div>
          </div>
        
      </div>

      </div>
  </div>
  </body>
</html>
